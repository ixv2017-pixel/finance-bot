import logging
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, MessageHandler, filters, ConversationHandler

# ---------------------------------------------------------
# âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª 
# ---------------------------------------------------------
# Ø§Ù„ØªÙˆÙƒÙŠÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
TOKEN = "8578181432:AAF-CBoRlheu-4vg21sfhQDMsBXz6xWkQ0o"

# Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
PRODUCT, NATIONALITY, ST_NST, SECTOR, SALARY, OBLIGATIONS, TENURE = range(7)

# ---------------------------------------------------------
# ğŸ“Š Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
# ---------------------------------------------------------
RATES_DB = [
    {"product": "Watani 1", "nationality": "Saudi", "type": "ST", "sector": "Gov't", "min": 2000, "max": 2999, "rate": 0.0753},
    {"product": "Watani 1", "nationality": "Saudi", "type": "ST", "sector": "Gov't", "min": 3000, "max": 3999, "rate": 0.0747},
    {"product": "Watani 1", "nationality": "Saudi", "type": "ST", "sector": "Gov't", "min": 4000, "max": 4999, "rate": 0.0741},
    {"product": "Watani 1", "nationality": "Saudi", "type": "ST", "sector": "Gov't", "min": 5000, "max": 5999, "rate": 0.0408},
    {"product": "Watani 1", "nationality": "Saudi", "type": "ST", "sector": "Gov't", "min": 6000, "max": 200000, "rate": 0.035},
    {"product": "Watani 2", "nationality": "Saudi", "type": "NST", "sector": "Pvt-C", "min": 10000, "max": 11999, "rate": 0.104},
    {"product": "Watani 2", "nationality": "Saudi", "type": "NST", "sector": "Pvt-C", "min": 12000, "max": 14999, "rate": 0.104},
    {"product": "Watani 2", "nationality": "Saudi", "type": "NST", "sector": "Pvt-C", "min": 15000, "max": 19999, "rate": 0.0995},
    {"product": "Watani 2", "nationality": "Saudi", "type": "NST", "sector": "Pvt-C", "min": 20000, "max": 24999, "rate": 0.0995},
    {"product": "Watani 1", "nationality": "Saudi", "type": "NST", "sector": "Military", "min": 2000, "max": 9999, "rate": 0.085}, 
    {"product": "Watani 1", "nationality": "Saudi", "type": "NST", "sector": "Military", "min": 10000, "max": 11999, "rate": 0.077},
    {"product": "Watani 1", "nationality": "Saudi", "type": "NST", "sector": "Military", "min": 12000, "max": 50000, "rate": 0.075},
]

# ---------------------------------------------------------
# ğŸ§® Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ
# ---------------------------------------------------------
def get_rate(product, nationality, st_nst, sector, salary):
    for r in RATES_DB:
        if (r['product'] == product and r['nationality'] == nationality and 
            r['type'] == st_nst and r['sector'] == sector and 
            r['min'] <= salary <= r['max']):
            return r['rate']
    if sector == 'Gov\'t': return 0.035
    if sector == 'Military': return 0.077
    if sector == 'Pvt-C': return 0.104
    return 0.055 

def calculate_finance(salary, obligations, tenure, rate, dbr=33.33):
    max_installment = (salary * (dbr / 100)) - obligations
    actual_installment = max(0, max_installment)
    total_obligation = actual_installment * tenure
    years = tenure / 12
    if (1 + (rate * years)) == 0: return 0,0,0,0,0
    financing_amount = total_obligation / (1 + (rate * years))
    profit_amount = total_obligation - financing_amount
    return financing_amount, actual_installment, total_obligation, profit_amount, rate

# ---------------------------------------------------------
# ğŸ¤– Ø§Ù„Ø¨ÙˆØª
# ---------------------------------------------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [['Watani 1', 'Watani 2']]
    await update.message.reply_text("ğŸ‘‹ **Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„**\nÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬:", reply_markup=ReplyKeyboardMarkup(kb, one_time_keyboard=True, resize_keyboard=True), parse_mode='Markdown')
    return PRODUCT

async def product_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['product'] = update.message.text
    kb = [['Saudi', 'Expats']]
    await update.message.reply_text("Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:", reply_markup=ReplyKeyboardMarkup(kb, one_time_keyboard=True, resize_keyboard=True))
    return NATIONALITY

async def nationality_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['nationality'] = update.message.text
    kb = [['ST', 'NST']]
    await update.message.reply_text("Ù†ÙˆØ¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ (ST: Ø±Ø§ØªØ¨ Ù…Ø­ÙˆÙ„ | NST: ØºÙŠØ± Ù…Ø­ÙˆÙ„):", reply_markup=ReplyKeyboardMarkup(kb, one_time_keyboard=True, resize_keyboard=True))
    return ST_NST

async def type_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['st_nst'] = update.message.text
    kb = [['Gov\'t', 'Semi-Gov\'t'], ['Military', 'Pvt-C'], ['Retirees / ATR', 'Pvt-A'], ['Pvt-B', 'Pvt-D']]
    await update.message.reply_text("Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:", reply_markup=ReplyKeyboardMarkup(kb, one_time_keyboard=True, resize_keyboard=True))
    return SECTOR

async def sector_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['sector'] = update.message.text
    await update.message.reply_text("ğŸ’° Ø£Ø¯Ø®Ù„ **ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨** (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·ØŒ Ù…Ø«Ø§Ù„: 10000):", reply_markup=ReplyKeyboardRemove(), parse_mode='Markdown')
    return SALARY

async def salary_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        context.user_data['salary'] = float(update.message.text)
        await update.message.reply_text("ğŸ’³ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (0 Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯):")
        return OBLIGATIONS
    except ValueError:
        await update.message.reply_text("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· Ù„Ù„Ø±Ø§ØªØ¨.")
        return SALARY

async def obligations_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        context.user_data['obligations'] = float(update.message.text)
        await update.message.reply_text("ğŸ“… Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø¨Ø§Ù„Ø£Ø´Ù‡Ø± (Ù…Ø«Ø§Ù„: 60):")
        return TENURE
    except ValueError:
        await update.message.reply_text("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· Ù„Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª.")
        return OBLIGATIONS

async def tenure_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        tenure = int(update.message.text)
        d = context.user_data
        rate = get_rate(d['product'], d['nationality'], d['st_nst'], d['sector'], d['salary'])
        principal, install, total, profit, used_rate = calculate_finance(d['salary'], d['obligations'], tenure, rate)
        msg = (f"âœ… **Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­**\nÙ€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€\nğŸ”¹ **Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„ØµØ§ÙÙŠ:** `{principal:,.2f}` Ø±ÙŠØ§Ù„\nğŸ”¹ **Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ:** `{install:,.2f}` Ø±ÙŠØ§Ù„\nğŸ”¹ **Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:** `{used_rate*100:.2f}%`\nğŸ”¹ **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¯Ø§Ø¯:** `{total:,.2f}` Ø±ÙŠØ§Ù„\nğŸ”¹ **Ø§Ù„Ø£Ø±Ø¨Ø§Ø­:** `{profit:,.2f}` Ø±ÙŠØ§Ù„\nÙ€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€Ù€\nØ§Ø¶ØºØ· /start Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯")
        await update.message.reply_text(msg, parse_mode='Markdown')
        return ConversationHandler.END
    except ValueError:
        await update.message.reply_text("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø¯Ø©.")
        return TENURE

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.", reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END

if __name__ == '__main__':
    application = ApplicationBuilder().token(TOKEN).build()
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            PRODUCT: [MessageHandler(filters.TEXT, product_step)],
            NATIONALITY: [MessageHandler(filters.TEXT, nationality_step)],
            ST_NST: [MessageHandler(filters.TEXT, type_step)],
            SECTOR: [MessageHandler(filters.TEXT, sector_step)],
            SALARY: [MessageHandler(filters.TEXT, salary_step)],
            OBLIGATIONS: [MessageHandler(filters.TEXT, obligations_step)],
            TENURE: [MessageHandler(filters.TEXT, tenure_step)],
        },
        fallbacks=[CommandHandler('cancel', cancel)]
    )
    application.add_handler(conv_handler)
    application.run_polling()


